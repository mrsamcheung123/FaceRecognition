<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>RTSP Multi-Stream Viewer</title>
    <style>
      :root {
        color-scheme: dark;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background-color: #090b12;
        color: #f5f5f5;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      header {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
      }

      main {
        flex: 1;
        padding: 1.5rem;
      }

      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
        gap: 1.5rem;
      }

      .feed {
        background: #111525;
        border-radius: 0.75rem;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 10px 35px rgba(0, 0, 0, 0.35);
      }

      .feed h2 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 0 0 0.5rem 0;
      }

      canvas {
        width: 100%;
        height: auto;
        aspect-ratio: 16 / 9;
        display: block;
        background: #05060c;
        border-radius: 0.5rem;
      }

      .status {
        margin-top: 0.75rem;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.78);
      }

      .error {
        color: #ff9f9f;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Live RTSP Streams</h1>
      <p>Two remote RTSP feeds relayed to your browser.</p>
    </header>
    <main>
      <div id="grid" class="grid"></div>
    </main>

    <template id="feed-template">
      <section class="feed">
        <h2></h2>
        <canvas></canvas>
        <p class="status">Connectingâ€¦</p>
      </section>
    </template>

    <script src="https://unpkg.com/rtsp-relay@2/browser/index.js"></script>
    <script type="module">
      const grid = document.getElementById('grid');
      const template = document.getElementById('feed-template');

      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';

      async function bootstrap() {
        let streams = [];

        try {
          const response = await fetch('/api/streams');
          streams = await response.json();
        } catch (error) {
          console.error('Unable to fetch stream metadata', error);
          grid.innerHTML = '<p class="error">Failed to load stream metadata.</p>';
          return;
        }

        streams.forEach((stream) => renderStreamCard(stream));
      }

      function renderStreamCard(stream) {
        const fragment = template.content.cloneNode(true);
        const section = fragment.querySelector('.feed');
        const title = fragment.querySelector('h2');
        const canvas = fragment.querySelector('canvas');
        const status = fragment.querySelector('.status');

        title.textContent = stream.label;

        grid.appendChild(fragment);

        try {
          const url = `${protocol}//${window.location.host}${stream.wsPath}`;
          window.loadPlayer({
            url,
            canvas,
            reconnect: true
          });
          status.textContent = 'Live';
        } catch (error) {
          console.error(`Failed to start stream ${stream.id}`, error);
          status.textContent = 'Error establishing stream';
          status.classList.add('error');
        }
      }

      bootstrap();
    </script>
  </body>
</html>
